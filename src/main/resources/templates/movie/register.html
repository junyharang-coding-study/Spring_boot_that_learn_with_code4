<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{layout/basic :: setContent(~{this::content})}">
  <th:block th:fragment="content">
    <h1 class="mt-4">영화 등록하기</h1>

    <form th:action="@{/movie/register}" th:method="post">
      <div class="form-group">
        <label>영화 제목</label>
        <input type="text" class="form-control" name="title" placeholder="영화 제목을 입력해 주세요!">
      </div>

      <div class="form-group fileForm">
        <label>영화 이미지</label>

        <div class="custom-file">
          <input type="file" class="custom-file-input files" id="fileInput" multiple>

          <label class="custom-file-label" data-browse="파일 찾기"></label>
        </div>
      </div>

      <div class="box"></div>

      <button type="submit" class="btn btn-primary">등록하기</button>

      <style>
        .uploadResult {
          width: 100%;
          background-color: gray;
          margin-top: 10px;
        }

        .uploadResult ul {
          display: flex;
          flex-flow: row;
          justify-content: center;
          align-items: center;
          vertical-align: top;
          overflow: auto;
        }

        .uploadResult ul li {
          list-style: none;
          padding: 10px;
          margin-left: 2em;
        }

        .uploadResult ul li img {
          width: 100px;
        }
      </style>

      <div class="uploadResult">
        <ul></ul>
      </div>
    </form>

    <script>
      $(document).ready(function (e) {
        var regex = new RegExp("(.*?)\.(exe|sh|zip|alz|tiff)$");
        var maxSize = 10485760; // 10MB

        function checkExtension(fileName, fileSize) {

          if (fileSize >= maxSize) {
            alert("파일의 크기가 너무 커요! 10MB 이하로 올려주세요!")
          } // if문 끝

          if(regex.test(fileName)) {
            alert("해당 종류의 파일은 업로드 할 수 없습니다!");
          }

          return true;
        }

        $(".custom-file-input").on("change", function () {

          var fileName = $(this).val().split("\\").pop();

          $(this).siblings(".custom-file-label").addClass("selected").html(fileName);

          var formData = new FormData();
          var inputFile = $(this);
          var files = inputFile[0].files;
          var appended = false;

          for (var i = 0; i < files.length; i++) {

            if (!checkExtension(files[i].name, files[i].size)) {
              return false;
            } // if문 끝

            console.log(files[i]);

            formData.append("uploadFiles", files[i]);
            appended = true;
          } // for문 끝

          // upload를 하지 않을 때
          if (!appended){
            return ;
          } // if문 끝

          for (var value of formData.values()) {
            console.log(value);
          } // for문 끝

          // 실제 업로드 부분
          // upload Ajax
          $.ajax({
            url : '/uploadAjax',
            processData : false,
            contentType : false,
            data : formData,
            type : 'POST',
            dataType : 'json',
            success : function (result) {
              console.log(result);
            }, error: function (jqXHR, textStatus, errorThrown) {
              console.log(textStatus);
            }
          }); // $.ajax 끝
        }); // change Event 끝
      }); // document ready 끝

      function showResult(uploadResultArr) {

        var uploadUL = $(".uploadResult ul");

        var str = "";

        $(uploadResultArr).each(function (i, obj) {

          str += "<li data-name='" + obj.fileName + "' data-path='"+obj.folderPath+"' data-uuid='"+obj.uuid+"'>";
          str += " <div>";
          str += "<button type='button' data-file=\'" + obj.imageURL + "\' "
          str += "class='btn-warning btn-sm'>X</button><br>";
          str += "<img src ='/display?fileName=" + obj.thumbnailURL + "'>";
          str += "</div>"
          str += "</li>";
        });

        uploadUL.append(str);

      }
    </script>

  </th:block>

</th:block>